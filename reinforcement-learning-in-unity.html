
<!DOCTYPE html>
<html lang="english">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />     <meta name="robots" content="" />     <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:300,400,400i,700" rel="stylesheet">     <link rel="stylesheet" type="text/css" href="https://jackmckew.dev/theme/stylesheet/style.min.css"> 
    <link rel="stylesheet" type="text/css" href="https://jackmckew.dev/theme/pygments/github.min.css">
    <link rel="stylesheet" type="text/css" href="https://jackmckew.dev/theme/font-awesome/css/fontawesome.css">
    <link rel="stylesheet" type="text/css" href="https://jackmckew.dev/theme/font-awesome/css/brands.css">
    <link rel="stylesheet" type="text/css" href="https://jackmckew.dev/theme/font-awesome/css/solid.css">
    <link rel="stylesheet" type="text/css" href="https://jackmckew.dev/theme/font-awesome.css">     <script src="https://jackmckew.dev/theme/tipuesearch/jquery.min.js"></script>
    <script src="https://jackmckew.dev/theme/tipuesearch/tipuesearch.min.js"></script>
    <script src="https://jackmckew.dev/theme/tipuesearch/tipuesearch.js"></script>
    <script src="https://jackmckew.dev/theme/tipuesearch/tipuesearch_set.js"></script>
    <link rel="stylesheet" href="https://jackmckew.dev/theme/tipuesearch/tipuesearch.css" />
    <script src="https://jackmckew.dev/tipuesearch_content.js"></script>
    <link href="https://jackmckew.dev/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Jack McKew's Blog Atom">     <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon"> <!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-131173168-2', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics --><meta name="author" content="Jack McKew" />
<meta name="description" content="I find machine&#39;s working automatically to complete a task one of the most fascinating things, imagine how good it feels to watch a machine that learns to do the task on it&#39;s own! Especially if you&#39;re the teacher, in this blog post, we&#39;re going to go through: How to set â€¦" />
<meta name="keywords" content="python, machine learning, ai">


<meta property="og:site_name" content="Jack McKew's Blog"/>
<meta property="og:title" content="Reinforcement Learning in Unity"/>
<meta property="og:description" content="I find machine&#39;s working automatically to complete a task one of the most fascinating things, imagine how good it feels to watch a machine that learns to do the task on it&#39;s own! Especially if you&#39;re the teacher, in this blog post, we&#39;re going to go through: How to set â€¦"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://jackmckew.dev/reinforcement-learning-in-unity.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2024-08-22 00:00:00+10:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://jackmckew.dev/author/jack-mckew.html">
<meta property="article:section" content="Python"/>
<meta property="article:tag" content="python"/>
<meta property="article:tag" content="machine learning"/>
<meta property="article:tag" content="ai"/>
<meta property="og:image" content="https://jackmckew.dev/img/late-training.gif">

    <title>Jack McKew's Blog &ndash; Reinforcement Learning in Unity</title>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client="
     crossorigin="anonymous"></script>
</head>

<body>
    <aside>
        <div>
            <a href="https://jackmckew.dev">
        <img src="/jm-photo.jpg" alt="Jack McKew's Blog" title="Jack McKew's Blog">
      </a>
            <h1><a href="https://jackmckew.dev">Jack McKew's Blog</a></h1>

            <p>Engineer | Software Developer | Data Scientist</p>            <p>Number of Posts: 110</p>
            <p>Number of Words: 81,726</p>
            <p>Number of Lines of Code 5,763</p>
            <form class="navbar-search" action="/search.html" role="search">
                <input type="text" name="q" id="tipue_search_input" placeholder="Search..">
            </form>
            <style>
                .bmc-button img {
                    height: 34px !important;
                    width: 35px !important;
                    margin-bottom: 1px !important;
                    box-shadow: none !important;
                    border: none !important;
                    vertical-align: middle !important;
                }
                
                .bmc-button {
                    margin-top: 15px !important;
                    margin-bottom: 20px !important;
                    padding: 7px 15px 7px 10px !important;
                    line-height: 35px !important;
                    height: 51px !important;
                    text-decoration: none !important;
                    display: inline-flex !important;
                    color: #ffffff !important;
                    /* background-color: #FF813F !important; */
                    border-radius: 5px !important;
                    border: 1px solid transparent !important;
                    padding: 7px 15px 7px 10px !important;
                    font-size: 22px !important;
                    letter-spacing: 0.6px !important;
                    box-shadow: 0px 1px 2px rgba(190, 190, 190, 0.5) !important;
                    -webkit-box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;
                    font-family: 'Cookie', cursive !important;
                    -webkit-box-sizing: border-box !important;
                    box-sizing: border-box !important;
                }
                
                .bmc-button:hover,
                .bmc-button:active,
                .bmc-button:focus {
                    -webkit-box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;
                    text-decoration: none !important;
                    box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;
                    opacity: 0.85 !important;
                    color: #ffffff !important;
                }
            </style>
            <link href="https://fonts.googleapis.com/css?family=Cookie" rel="stylesheet">
            <!-- <a class="bmc-button btn" target="_blank" href="https://www.buymeacoffee.com/jackmckew"><img src="https://jackmckew.dev/theme/img/pizza.png" alt="ðŸ•"><span style="margin-left:5px;font-size:28px !important;">Buy me a Pizza</span></a> -->
            <nav>
                <ul class="list">
                    <li><a target="https://jackmckew.github.io/" href="https://jackmckew.github.io/">Portfolio</a></li>
                    <li><a target="https://jackmckew.dev/files/Jack_McKew_CV.pdf" href="https://jackmckew.dev/files/Jack_McKew_CV.pdf">CV/Resume</a></li>
                </ul>
            </nav>

            <ul class="social">
                <li>
                    <a  class="sc-twitter" href="https://twitter.com/Jac_McQ" target="_blank">
                        <i class="fab fa-twitter">
            </i>
                    </a>
                </li>
                <li>
                    <a  class="sc-linkedin" href="https://www.linkedin.com/in/jack-mckew/" target="_blank">
                        <i class="fab fa-linkedin">
            </i>
                    </a>
                </li>
                <li>
                    <a  class="sc-github" href="https://github.com/JackMcKew" target="_blank">
                        <i class="fab fa-github">
            </i>
                    </a>
                </li>
            </ul>
        </div>


    </aside>
    <main>
        <nav>
            <a href="https://jackmckew.dev"> Home</a>             <a href="/archives.html">Archives</a>             <a href="/categories.html">Categories</a>             <a href="/tags.html">Tags</a>             <a href="/sitemap.xml">Sitemap</a>             <a href="https://jackmckew.dev/feeds/all.atom.xml"> Atom</a>         </nav>
<article class="single">
  <header>
      
    <h1 id="reinforcement-learning-in-unity">Reinforcement Learning in Unity</h1>
    <p>
       Posted on Thu 22 August 2024 in <a href="https://jackmckew.dev/category/python.html">Python</a>

        &#8226; 6 min read
    </p>
  </header>


  <div>
    <body><p>I find machine's working automatically to complete a task one of the most fascinating things, imagine how good it feels to watch a machine that learns to do the task on it's own! Especially if you're the teacher, in this blog post, we're going to go through:</p>
<ol>
<li>How to set up an environment in Unity</li>
<li>How to interface with ML Agents to train an agent to complete a task</li>
<li>Watch our trained model complete the task</li>
</ol>
<p>Before we dive into anything technical, let's see something I prepared earlier!</p>
<p><img alt="Model Late Training" class="img-fluid" src="https://jackmckew.dev/img/late-training.gif"/></p>
<h2 id="setup-ml-agents-and-unity-environment">Setup ML Agents and Unity Environment</h2>
<p>See my previous post on how to set up ML Agents (on an apple silicon mac) here: [INSERT LINK TO POST]</p>
<h2 id="setup-environment">Setup Environment</h2>
<p>The goal that we will set for our agent to complete will be to roll towards a reward until it touches it. To do that we will need:</p>
<ul>
<li>A character for our agent to control</li>
<li>Movement controls for our agent</li>
<li>Boundaries for our agent to stay within (floor, walls, etc)</li>
<li>The reward for our agent to touch</li>
</ul>
<h3 id="character">Character</h3>
<p>Keeping things simple, we will create our agent to be a sphere with 2 eyes (with no collision), to add some flavour to our character.</p>
<p><img alt="Character" class="img-fluid" src="https://jackmckew.dev/img/character.png"/></p>
<h4 id="movement">Movement</h4>
<p>To give the ability for our agent to control the character, we will attach a script to the character. This can be achieved through selecting the sphere &gt; add component &gt; new script</p>
<p><img alt="Script" class="img-fluid" src="https://jackmckew.dev/img/script-attached.png"/></p>
<p>Inside the script, we will use Unity's <code>addForce</code> to give us the movement, and we will make use of MLAgents' heuristics such that we can toggle between agent controlled movement and controlled by us. If you leave this setting to default, it'll automatically choose for you.</p>
<table class="highlighttable table-striped table"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">using</span> <span class="nn">Unity.MLAgents</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Unity.MLAgents.Actuators</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Unity.MLAgents.Sensors</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">RewardAgent</span> <span class="p">:</span> <span class="n">Agent</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnActionReceived</span><span class="p">(</span><span class="n">ActionBuffers</span> <span class="n">actions</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// // Calculate movement direction</span>
        <span class="n">Vector3</span> <span class="n">movementDirection</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector3</span><span class="p">(</span>
            <span class="n">actions</span><span class="p">.</span><span class="n">ContinuousActions</span><span class="p">[</span><span class="m">0</span><span class="p">],</span>
            <span class="m">0f</span><span class="p">,</span>
            <span class="n">actions</span><span class="p">.</span><span class="n">ContinuousActions</span><span class="p">[</span><span class="m">1</span><span class="p">]</span>
        <span class="p">).</span><span class="n">normalized</span><span class="p">;</span>

        <span class="c1">// If there is movement input, apply force to move the sphere</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">movementDirection</span> <span class="p">!=</span> <span class="n">Vector3</span><span class="p">.</span><span class="n">zero</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// Rotate the movement direction relative to the global coordinate system</span>
            <span class="n">movementDirection</span> <span class="p">=</span>
                <span class="n">Quaternion</span><span class="p">.</span><span class="n">Euler</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">Camera</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">eulerAngles</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="m">0</span><span class="p">)</span> <span class="p">*</span> <span class="n">movementDirection</span><span class="p">;</span>

            <span class="c1">// Apply force to move the sphere</span>
            <span class="n">agentRigidBody</span><span class="p">.</span><span class="n">AddForce</span><span class="p">(</span><span class="n">movementDirection</span> <span class="p">*</span> <span class="n">speed</span><span class="p">,</span> <span class="n">ForceMode</span><span class="p">.</span><span class="n">Acceleration</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Heuristic</span><span class="p">(</span><span class="k">in</span> <span class="n">ActionBuffers</span> <span class="n">actionsOut</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ActionSegment</span><span class="p">&lt;</span><span class="kt">float</span><span class="p">&gt;</span> <span class="n">continuousActions</span> <span class="p">=</span> <span class="n">actionsOut</span><span class="p">.</span><span class="n">ContinuousActions</span><span class="p">;</span>
        <span class="n">continuousActions</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">=</span> <span class="n">Input</span><span class="p">.</span><span class="n">GetAxisRaw</span><span class="p">(</span><span class="s">"Horizontal"</span><span class="p">);</span>
        <span class="n">continuousActions</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="p">=</span> <span class="n">Input</span><span class="p">.</span><span class="n">GetAxisRaw</span><span class="p">(</span><span class="s">"Vertical"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></tbody></table>
<h3 id="boundaries">Boundaries</h3>
<p>Once you've created the desired environment for our agent to move in, create a prefab by nesting all of your game objects underneath a common parent (named <code>Environment</code>) and drag it into your project directory. This will enable us to copy and paste our prefab as many times as we want to train at scale. The walls transparent as they are distracting when there's lots of agents on the screen.</p>
<p><img alt="Environment" class="img-fluid" src="https://jackmckew.dev/img/environment.png"/></p>
<blockquote>
<p>Ensure to use local position in your scripts if you are using a prefab otherwise it'll try to use the global position and strange things <strong>will happen</strong></p>
</blockquote>
<h2 id="integrate-ml-agents">Integrate ML Agents</h2>
<p>To integrate MLAgents we need to provide a few things:</p>
<ol>
<li>AddObservation to give our agent information about it's world</li>
<li>AddReward when our agents do good (positive)/bad (negative)</li>
<li>EndEpisode when our agent has either completed or failed the task</li>
</ol>
<h3 id="addobservation">AddObservation</h3>
<p>Overriding the public function of <code>CollectionObservations</code> enables us to give the agent the input to it's neural network. Ensure to set the <code>Vector Space</code> size correctly, in our scenario we have a space of 12, as we are passing through 4 vectors comprising of 3 elements (x, y, z).</p>
<p><img alt="Observations" class="img-fluid" src="https://jackmckew.dev/img/observation.png"/></p>
<table class="highlighttable table-striped table"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">CollectObservations</span><span class="p">(</span><span class="n">VectorSensor</span> <span class="n">sensor</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sensor</span><span class="p">.</span><span class="n">AddObservation</span><span class="p">(</span><span class="n">transform</span><span class="p">.</span><span class="n">localPosition</span><span class="p">);</span>
        <span class="n">sensor</span><span class="p">.</span><span class="n">AddObservation</span><span class="p">(</span><span class="n">rewardTransform</span><span class="p">.</span><span class="n">localPosition</span><span class="p">);</span>
        <span class="n">sensor</span><span class="p">.</span><span class="n">AddObservation</span><span class="p">(</span><span class="n">agentRigidBody</span><span class="p">.</span><span class="n">velocity</span><span class="p">);</span>
        <span class="n">sensor</span><span class="p">.</span><span class="n">AddObservation</span><span class="p">(</span><span class="n">agentRigidBody</span><span class="p">.</span><span class="n">angularVelocity</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div>
</td></tr></tbody></table>
<h3 id="addreward">AddReward</h3>
<p>Since our task is whether the character has either collided with the reward (success) or with the wall (failure), we set the collision function on our character to respectively <code>AddReward</code> and <code>EndEpisode</code> for our two outcomes. This will tell the model when it's training to reset the state of the environment, and for our sake, we'll colour the floor to whether they've succeeded or failed as well.</p>
<table class="highlighttable table-striped table"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">void</span> <span class="nf">OnCollisionEnter</span><span class="p">(</span><span class="n">Collision</span> <span class="n">collision</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">collision</span><span class="p">.</span><span class="n">gameObject</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="s">"Reward"</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">AddReward</span><span class="p">(</span><span class="m">10f</span><span class="p">);</span>
            <span class="n">ResetRewardPosition</span><span class="p">();</span>
            <span class="n">floorMeshRenderer</span><span class="p">.</span><span class="n">material</span> <span class="p">=</span> <span class="n">winMaterial</span><span class="p">;</span>
            <span class="n">EndEpisode</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">collision</span><span class="p">.</span><span class="n">gameObject</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="s">"Wall"</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">AddReward</span><span class="p">(-</span><span class="m">1f</span><span class="p">);</span>
            <span class="n">floorMeshRenderer</span><span class="p">.</span><span class="n">material</span> <span class="p">=</span> <span class="n">loseMaterial</span><span class="p">;</span>
            <span class="n">ResetAgentPosition</span><span class="p">();</span>
            <span class="n">EndEpisode</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>
</td></tr></tbody></table>
<p>The full script can be found within details:
</p><details><p></p>
<table class="highlighttable table-striped table"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">using</span> <span class="nn">Unity.MLAgents</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Unity.MLAgents.Actuators</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Unity.MLAgents.Sensors</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">RewardAgent</span> <span class="p">:</span> <span class="n">Agent</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnActionReceived</span><span class="p">(</span><span class="n">ActionBuffers</span> <span class="n">actions</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// // Calculate movement direction</span>
        <span class="n">Vector3</span> <span class="n">movementDirection</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector3</span><span class="p">(</span>
            <span class="n">actions</span><span class="p">.</span><span class="n">ContinuousActions</span><span class="p">[</span><span class="m">0</span><span class="p">],</span>
            <span class="m">0f</span><span class="p">,</span>
            <span class="n">actions</span><span class="p">.</span><span class="n">ContinuousActions</span><span class="p">[</span><span class="m">1</span><span class="p">]</span>
        <span class="p">).</span><span class="n">normalized</span><span class="p">;</span>

        <span class="c1">// If there is movement input, apply force to move the sphere</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">movementDirection</span> <span class="p">!=</span> <span class="n">Vector3</span><span class="p">.</span><span class="n">zero</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// Rotate the movement direction relative to the global coordinate system</span>
            <span class="n">movementDirection</span> <span class="p">=</span>
                <span class="n">Quaternion</span><span class="p">.</span><span class="n">Euler</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">Camera</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">eulerAngles</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="m">0</span><span class="p">)</span> <span class="p">*</span> <span class="n">movementDirection</span><span class="p">;</span>

            <span class="c1">// Apply force to move the sphere</span>
            <span class="n">agentRigidBody</span><span class="p">.</span><span class="n">AddForce</span><span class="p">(</span><span class="n">movementDirection</span> <span class="p">*</span> <span class="n">speed</span><span class="p">,</span> <span class="n">ForceMode</span><span class="p">.</span><span class="n">Acceleration</span><span class="p">);</span>

            <span class="c1">// Rotate the sphere to face the movement direction</span>
            <span class="c1">// transform.rotation = Quaternion.LookRotation(movementDirection);</span>
        <span class="p">}</span>

        <span class="n">AddReward</span><span class="p">(-</span><span class="m">1</span> <span class="p">*</span> <span class="p">(</span><span class="n">StepCount</span> <span class="p">/</span> <span class="m">1000</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Heuristic</span><span class="p">(</span><span class="k">in</span> <span class="n">ActionBuffers</span> <span class="n">actionsOut</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ActionSegment</span><span class="p">&lt;</span><span class="kt">float</span><span class="p">&gt;</span> <span class="n">continuousActions</span> <span class="p">=</span> <span class="n">actionsOut</span><span class="p">.</span><span class="n">ContinuousActions</span><span class="p">;</span>
        <span class="n">continuousActions</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">=</span> <span class="n">Input</span><span class="p">.</span><span class="n">GetAxisRaw</span><span class="p">(</span><span class="s">"Horizontal"</span><span class="p">);</span>
        <span class="n">continuousActions</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="p">=</span> <span class="n">Input</span><span class="p">.</span><span class="n">GetAxisRaw</span><span class="p">(</span><span class="s">"Vertical"</span><span class="p">);</span>
    <span class="p">}</span>

<span class="na">    [SerializeField]</span>
    <span class="k">private</span> <span class="n">Material</span> <span class="n">winMaterial</span><span class="p">;</span>

<span class="na">    [SerializeField]</span>
    <span class="k">private</span> <span class="n">Material</span> <span class="n">loseMaterial</span><span class="p">;</span>

<span class="na">    [SerializeField]</span>
    <span class="k">private</span> <span class="n">MeshRenderer</span> <span class="n">floorMeshRenderer</span><span class="p">;</span>

<span class="na">    [SerializeField]</span>
    <span class="k">private</span> <span class="n">Transform</span> <span class="n">rewardTransform</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">CollectObservations</span><span class="p">(</span><span class="n">VectorSensor</span> <span class="n">sensor</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sensor</span><span class="p">.</span><span class="n">AddObservation</span><span class="p">(</span><span class="n">transform</span><span class="p">.</span><span class="n">localPosition</span><span class="p">);</span>
        <span class="n">sensor</span><span class="p">.</span><span class="n">AddObservation</span><span class="p">(</span><span class="n">rewardTransform</span><span class="p">.</span><span class="n">localPosition</span><span class="p">);</span>
        <span class="n">sensor</span><span class="p">.</span><span class="n">AddObservation</span><span class="p">(</span><span class="n">agentRigidBody</span><span class="p">.</span><span class="n">velocity</span><span class="p">);</span>
        <span class="n">sensor</span><span class="p">.</span><span class="n">AddObservation</span><span class="p">(</span><span class="n">agentRigidBody</span><span class="p">.</span><span class="n">angularVelocity</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">float</span> <span class="n">speed</span> <span class="p">=</span> <span class="m">10f</span><span class="p">;</span> <span class="c1">// Speed of sphere movement</span>
    <span class="k">private</span> <span class="n">Rigidbody</span> <span class="n">agentRigidBody</span><span class="p">;</span>

    <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// Get the Rigidbody component</span>
        <span class="n">agentRigidBody</span> <span class="p">=</span> <span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">Rigidbody</span><span class="p">&gt;();</span>
        <span class="n">ResetRewardPosition</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">void</span> <span class="nf">ResetAgentPosition</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// Reset the force on the object</span>
        <span class="n">agentRigidBody</span><span class="p">.</span><span class="n">velocity</span> <span class="p">=</span> <span class="n">Vector3</span><span class="p">.</span><span class="n">zero</span><span class="p">;</span>
        <span class="n">agentRigidBody</span><span class="p">.</span><span class="n">angularVelocity</span> <span class="p">=</span> <span class="n">Vector3</span><span class="p">.</span><span class="n">zero</span><span class="p">;</span>
        <span class="n">transform</span><span class="p">.</span><span class="n">localPosition</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector3</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="n">rewardTransform</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">localPosition</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// These are recorded in localPosition</span>
    <span class="k">private</span> <span class="n">Vector3</span> <span class="n">minBounds</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector3</span><span class="p">(-</span><span class="m">0.5f</span><span class="p">,</span> <span class="m">0f</span><span class="p">,</span> <span class="p">-</span><span class="m">3f</span><span class="p">);</span>
    <span class="k">private</span> <span class="n">Vector3</span> <span class="n">maxBounds</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector3</span><span class="p">(</span><span class="m">8f</span><span class="p">,</span> <span class="m">0f</span><span class="p">,</span> <span class="m">5.5f</span><span class="p">);</span>

    <span class="k">private</span> <span class="kt">float</span> <span class="n">minDistance</span> <span class="p">=</span> <span class="m">1f</span><span class="p">;</span>

    <span class="k">private</span> <span class="n">Vector3</span> <span class="nf">GenerateRandomPosition</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Vector3</span><span class="p">(</span>
            <span class="n">Random</span><span class="p">.</span><span class="n">Range</span><span class="p">(</span><span class="n">minBounds</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">maxBounds</span><span class="p">.</span><span class="n">x</span><span class="p">),</span>
            <span class="m">0f</span><span class="p">,</span>
            <span class="n">Random</span><span class="p">.</span><span class="n">Range</span><span class="p">(</span><span class="n">minBounds</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="n">maxBounds</span><span class="p">.</span><span class="n">z</span><span class="p">)</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="kt">bool</span> <span class="nf">IsPositionValid</span><span class="p">(</span><span class="n">Vector3</span> <span class="n">position</span><span class="p">,</span> <span class="n">Vector3</span> <span class="n">referencePosition</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">Vector3</span><span class="p">.</span><span class="n">Distance</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">referencePosition</span><span class="p">)</span> <span class="p">&gt;=</span> <span class="n">minDistance</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">Vector3</span> <span class="nf">GetRandomPosition</span><span class="p">(</span><span class="n">Vector3</span> <span class="n">referencePosition</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">int</span> <span class="n">maxAttempts</span> <span class="p">=</span> <span class="m">100</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">attempts</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>

        <span class="k">do</span>
        <span class="p">{</span>
            <span class="n">Vector3</span> <span class="n">randomPosition</span> <span class="p">=</span> <span class="n">GenerateRandomPosition</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">IsPositionValid</span><span class="p">(</span><span class="n">randomPosition</span><span class="p">,</span> <span class="n">referencePosition</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="n">randomPosition</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">attempts</span><span class="p">++;</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">attempts</span> <span class="p">&lt;</span> <span class="n">maxAttempts</span><span class="p">);</span>

        <span class="n">Debug</span><span class="p">.</span><span class="n">LogWarning</span><span class="p">(</span>
            <span class="s">"Failed to find a valid random position within bounds after "</span>
                <span class="p">+</span> <span class="n">maxAttempts</span>
                <span class="p">+</span> <span class="s">" attempts."</span>
        <span class="p">);</span>
        <span class="k">return</span> <span class="n">Vector3</span><span class="p">.</span><span class="n">zero</span><span class="p">;</span> <span class="c1">// Return zero if failed to find a valid position</span>
    <span class="p">}</span>

    <span class="k">void</span> <span class="nf">ResetRewardPosition</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">Vector3</span> <span class="n">randomPosition</span> <span class="p">=</span> <span class="n">GetRandomPosition</span><span class="p">(</span><span class="n">transform</span><span class="p">.</span><span class="n">localPosition</span><span class="p">);</span>
        <span class="n">randomPosition</span><span class="p">.</span><span class="n">y</span> <span class="p">=</span> <span class="n">transform</span><span class="p">.</span><span class="n">localPosition</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
        <span class="n">rewardTransform</span><span class="p">.</span><span class="n">localPosition</span> <span class="p">=</span> <span class="n">randomPosition</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">float</span> <span class="n">maxBound</span> <span class="p">=</span> <span class="m">3f</span><span class="p">;</span> <span class="c1">// Maximum bounds for random position</span>

    <span class="k">private</span> <span class="kt">float</span> <span class="n">episodeStartTime</span><span class="p">;</span>
    <span class="k">private</span> <span class="kt">float</span> <span class="n">timePenaltyMultiplier</span> <span class="p">=</span> <span class="m">0.1f</span><span class="p">;</span> <span class="c1">// Adjust this multiplier as needed</span>

    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnEpisodeBegin</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// Reset any necessary variables at the beginning of each episode</span>
        <span class="n">episodeStartTime</span> <span class="p">=</span> <span class="n">Time</span><span class="p">.</span><span class="n">time</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">void</span> <span class="nf">OnCollisionEnter</span><span class="p">(</span><span class="n">Collision</span> <span class="n">collision</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">collision</span><span class="p">.</span><span class="n">gameObject</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="s">"Reward"</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">AddReward</span><span class="p">(</span><span class="m">10f</span><span class="p">);</span>
            <span class="n">ResetRewardPosition</span><span class="p">();</span>
            <span class="n">floorMeshRenderer</span><span class="p">.</span><span class="n">material</span> <span class="p">=</span> <span class="n">winMaterial</span><span class="p">;</span>
            <span class="n">EndEpisode</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">collision</span><span class="p">.</span><span class="n">gameObject</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="s">"Wall"</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">AddReward</span><span class="p">(-</span><span class="m">1f</span><span class="p">);</span>
            <span class="n">floorMeshRenderer</span><span class="p">.</span><span class="n">material</span> <span class="p">=</span> <span class="n">loseMaterial</span><span class="p">;</span>
            <span class="n">ResetAgentPosition</span><span class="p">();</span>
            <span class="n">EndEpisode</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></tbody></table>
</details>
<h3 id="train">Train</h3>
<p>Training our model is quite straight forward with MLAgents, run in your python virtual environment <code>ml-agents-learn</code> and then heading back to Unity's Editor and pressing the Play button.</p>
<blockquote>
<p>Adding <code>--force</code> will overwrite any existing training
Adding <code>--run-id</code> will give your run's a specific ID which is handy</p>
</blockquote>
<p>Since we created a prefab, we can copy and paste our prefab as many times as we want to train in parallel.</p>
<p><img alt="Training" class="img-fluid" src="https://jackmckew.dev/img/training.gif"/></p>
<h4 id="quirks">Quirks</h4>
<p>In an earlier attempt, I'd left the agent always starting in the same place, and the reward would <strong>always</strong> reset position. After training the model, the model decided the most optimal way of this task, was to run into the wall constantly in hope's that the reward would reset close enough. This is the life of reinforcement learning.</p>
<p><img alt="wall is best" class="img-fluid" src="https://jackmckew.dev/img/wall-is-best.gif"/></p>
<h3 id="run-trained-model">Run Trained Model</h3>
<p>To show off our model once it's complete, for clarity sake we 'disable' the remainder of our prefabs (even though they will run in the background) and we drag our model's <code>.onnx</code> file into our character's <code>Behaviour Parameters</code> &gt; <code>Model</code>, this will instruct the editor to use this for our character's brain.</p>
<p><img alt="trained model" class="img-fluid" src="https://jackmckew.dev/img/trained-model.gif"/></p></body>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://jackmckew.dev/tag/python.html">python</a>
      <a href="https://jackmckew.dev/tag/machine-learning.html">machine learning</a>
      <a href="https://jackmckew.dev/tag/ai.html">ai</a>
    </p>
  </div>


  <div class="neighbors">
    <a class="btn float-left" href="https://jackmckew.dev/ml-agents-for-unity-on-apple-silicon-m1m2m3.html" title="ML Agents for Unity on Apple Silicon (M1/M2/M3)">
      <i class="fa fa-angle-left"></i>  Previous Post
    </a>
  </div>

  <div class="related-posts">
    <h4> You might enjoy</h4>
    <ul class="related-posts">
      <li><a href="https://jackmckew.dev/hands-on-machine-learning-chapter-3.html">Hands On Machine Learning Chapter 3</a></li>
      <li><a href="https://jackmckew.dev/differential-privacy.html">Differential Privacy</a></li>
      <li><a href="https://jackmckew.dev/shallow-vs-deep-copy-in-python.html">Shallow vs Deep Copy in Python</a></li>
      <li><a href="https://jackmckew.dev/types-of-averages-means.html">Types of Averages (Means)</a></li>
      <li><a href="https://jackmckew.dev/dataclasses-vs-attrs-vs-pydantic.html">Dataclasses vs Attrs vs Pydantic</a></li>
    </ul>
  </div>


<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'jackmckew-dev';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
     Please enable JavaScript to view comments.
</noscript>
<!-- End Disqus -->
</article>

        <footer>
<p>&copy;  </p>
<p> Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme</p>        </footer>
    </main>

<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Jack McKew's Blog ",
  "url" : "https://jackmckew.dev",
  "image": "/jm-photo.jpg",
  "description": ""
}
</script>    <script>
        $(document).ready(function() {
            $('#tipue_search_input').tipuesearch();
        });
    </script>
</body>

</html>