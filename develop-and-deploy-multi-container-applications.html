
<!DOCTYPE html>
<html lang="english">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />     <meta name="robots" content="" />     <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:300,400,400i,700" rel="stylesheet">     <link rel="stylesheet" type="text/css" href="https://jackmckew.dev/theme/stylesheet/style.min.css"> 
    <link rel="stylesheet" type="text/css" href="https://jackmckew.dev/theme/pygments/github.min.css">
    <link rel="stylesheet" type="text/css" href="https://jackmckew.dev/theme/font-awesome/css/fontawesome.css">
    <link rel="stylesheet" type="text/css" href="https://jackmckew.dev/theme/font-awesome/css/brands.css">
    <link rel="stylesheet" type="text/css" href="https://jackmckew.dev/theme/font-awesome/css/solid.css">
    <link rel="stylesheet" type="text/css" href="https://jackmckew.dev/theme/font-awesome.css">     <script src="https://jackmckew.dev/theme/tipuesearch/jquery.min.js"></script>
    <script src="https://jackmckew.dev/theme/tipuesearch/tipuesearch.min.js"></script>
    <script src="https://jackmckew.dev/theme/tipuesearch/tipuesearch.js"></script>
    <script src="https://jackmckew.dev/theme/tipuesearch/tipuesearch_set.js"></script>
    <link rel="stylesheet" href="https://jackmckew.dev/theme/tipuesearch/tipuesearch.css" />
    <script src="https://jackmckew.dev/tipuesearch_content.js"></script>
    <link href="https://jackmckew.dev/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Jack McKew's Blog Atom">     <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon"> <!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-131173168-2', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics --><meta name="author" content="Jack McKew" />
<meta name="description" content="Following on with previous posts on this blog. This post will be going through how to develop &amp; deploy a multi-container application, our application (albeit basic) will allow users to input a number which will correspond to the index in the Fibonacci sequence, and our application will respond with the computed …" />
<meta name="keywords" content="software">


<meta property="og:site_name" content="Jack McKew's Blog"/>
<meta property="og:title" content="Develop and Deploy Multi-Container Applications"/>
<meta property="og:description" content="Following on with previous posts on this blog. This post will be going through how to develop &amp; deploy a multi-container application, our application (albeit basic) will allow users to input a number which will correspond to the index in the Fibonacci sequence, and our application will respond with the computed …"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://jackmckew.dev/develop-and-deploy-multi-container-applications.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2020-11-06 00:00:00+11:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://jackmckew.dev/author/jack-mckew.html">
<meta property="article:section" content="Software"/>
<meta property="article:tag" content="software"/>
<meta property="og:image" content="https://jackmckew.dev/img/vue-fib.png">

    <title>Jack McKew's Blog &ndash; Develop and Deploy Multi-Container Applications</title>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client="
     crossorigin="anonymous"></script>
</head>

<body>
    <aside>
        <div>
            <a href="https://jackmckew.dev">
        <img src="/jm-photo.jpg" alt="Jack McKew's Blog" title="Jack McKew's Blog">
      </a>
            <h1><a href="https://jackmckew.dev">Jack McKew's Blog</a></h1>

            <p>Engineer | Software Developer | Data Scientist</p>            <p>Number of Posts: 110</p>
            <p>Number of Words: 81,726</p>
            <p>Number of Lines of Code 5,763</p>
            <form class="navbar-search" action="/search.html" role="search">
                <input type="text" name="q" id="tipue_search_input" placeholder="Search..">
            </form>
            <style>
                .bmc-button img {
                    height: 34px !important;
                    width: 35px !important;
                    margin-bottom: 1px !important;
                    box-shadow: none !important;
                    border: none !important;
                    vertical-align: middle !important;
                }
                
                .bmc-button {
                    margin-top: 15px !important;
                    margin-bottom: 20px !important;
                    padding: 7px 15px 7px 10px !important;
                    line-height: 35px !important;
                    height: 51px !important;
                    text-decoration: none !important;
                    display: inline-flex !important;
                    color: #ffffff !important;
                    /* background-color: #FF813F !important; */
                    border-radius: 5px !important;
                    border: 1px solid transparent !important;
                    padding: 7px 15px 7px 10px !important;
                    font-size: 22px !important;
                    letter-spacing: 0.6px !important;
                    box-shadow: 0px 1px 2px rgba(190, 190, 190, 0.5) !important;
                    -webkit-box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;
                    font-family: 'Cookie', cursive !important;
                    -webkit-box-sizing: border-box !important;
                    box-sizing: border-box !important;
                }
                
                .bmc-button:hover,
                .bmc-button:active,
                .bmc-button:focus {
                    -webkit-box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;
                    text-decoration: none !important;
                    box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;
                    opacity: 0.85 !important;
                    color: #ffffff !important;
                }
            </style>
            <link href="https://fonts.googleapis.com/css?family=Cookie" rel="stylesheet">
            <!-- <a class="bmc-button btn" target="_blank" href="https://www.buymeacoffee.com/jackmckew"><img src="https://jackmckew.dev/theme/img/pizza.png" alt="🍕"><span style="margin-left:5px;font-size:28px !important;">Buy me a Pizza</span></a> -->
            <nav>
                <ul class="list">
                    <li><a target="https://jackmckew.github.io/" href="https://jackmckew.github.io/">Portfolio</a></li>
                    <li><a target="https://jackmckew.dev/files/Jack_McKew_Resume.pdf" href="https://jackmckew.dev/files/Jack_McKew_Resume.pdf">Resume</a></li>
                </ul>
            </nav>

            <ul class="social">
                <li>
                    <a  class="sc-twitter" href="https://twitter.com/Jac_McQ" target="_blank">
                        <i class="fab fa-twitter">
            </i>
                    </a>
                </li>
                <li>
                    <a  class="sc-linkedin" href="https://www.linkedin.com/in/jack-mckew/" target="_blank">
                        <i class="fab fa-linkedin">
            </i>
                    </a>
                </li>
                <li>
                    <a  class="sc-github" href="https://github.com/JackMcKew" target="_blank">
                        <i class="fab fa-github">
            </i>
                    </a>
                </li>
            </ul>
        </div>


    </aside>
    <main>
        <nav>
            <a href="https://jackmckew.dev"> Home</a>             <a href="/archives.html">Archives</a>             <a href="/categories.html">Categories</a>             <a href="/tags.html">Tags</a>             <a href="/sitemap.xml">Sitemap</a>             <a href="https://jackmckew.dev/feeds/all.atom.xml"> Atom</a>         </nav>
<article class="single">
  <header>
      
    <h1 id="develop-and-deploy-multi-container-applications">Develop and Deploy Multi-Container Applications</h1>
    <p>
       Posted on Fri 06 November 2020 in <a href="https://jackmckew.dev/category/software.html">Software</a>

        &#8226; 12 min read
    </p>
  </header>


  <div>
    <body><p>Following on with previous posts on this blog. This post will be going through how to develop &amp; deploy a multi-container application, our application (albeit basic) will allow users to input a number which will correspond to the index in the Fibonacci sequence, and our application will respond with the computed number. Redis will store this number locally to give users a list of recently requested indexes, and PostgreSQL will store the input and output. More specifically we will be using the following technologies:</p>
<table class="table table-striped">
<thead>
<tr>
<th>Technology</th>
<th>Use</th>
</tr>
</thead>
<tbody>
<tr>
<td>Docker</td>
<td>Docker will be used to containerization of the services inside our app</td>
</tr>
<tr>
<td>Amazon Web Services (AWS) Elastic Beanstalk</td>
<td>Elastic Beanstalk will manage the deployment of our application</td>
</tr>
<tr>
<td>Vue</td>
<td>Vue is the front-end JavaScript framework that we will use</td>
</tr>
<tr>
<td>Express</td>
<td>Express is responsible for the API between Redis, PostgreSQL and Vue</td>
</tr>
<tr>
<td>Redis</td>
<td>Redis will store/retrieve any local data used by our users</td>
</tr>
<tr>
<td>PostgreSQL</td>
<td>PostgreSQL will be our database</td>
</tr>
<tr>
<td>Nginx</td>
<td>Nginx will handle the routing between our services</td>
</tr>
<tr>
<td>Github Actions</td>
<td>Github Actions will be our CI/CD platform for running tests before deploying</td>
</tr>
</tbody>
</table>
<p>Let's start by diving into each of the services inside our application and how to set them up.</p>
<blockquote>
<p>This post won't go into how to Dockerize each service in particular, more so how to connect them all together.</p>
</blockquote>
<p><em>Find all the source code for this project at: <a href="https://github.com/JackMcKew/multi-docker">https://github.com/JackMcKew/multi-docker</a></em></p>
<p>This post is apart of a series on Docker/Kubernetes, find the other posts at:</p>
<ul>
<li><a href="https://jackmckew.dev/intro-to-docker.html">Intro to Docker</a></li>
<li><a href="https://jackmckew.dev/develop-and-deploy-with-docker.html">Develop and Develop with Docker</a></li>
<li><a href="https://jackmckew.dev/intro-to-kubernetes.html">Intro to Kubernetes</a></li>
<li><a href="https://jackmckew.dev/developing-with-kubernetes.html">Developing with Kubernetes</a></li>
<li><a href="https://jackmckew.dev/deploying-with-kubernetes.html">Deploying with Kubernetes</a></li>
<li><a href="https://jackmckew.dev/deploy-a-node-web-app-to-aws-elastic-beanstalk-with-docker.html">Deploy a Node Web App to AWS Elastic Beanstalk with Docker</a></li>
</ul>
<h2 id="vue">Vue</h2>
<p><em>Find all the source code for the front end client at: <a href="https://github.com/JackMcKew/multi-docker/tree/master/client">https://github.com/JackMcKew/multi-docker/tree/master/client</a></em></p>
<p>Vue is a JavaScript framework for creating user interfaces. We will be using it for the 'front-end' portion of the application. Vue can be installed through npm and once installed, we can run <code>vue create project_name</code> in the command line to create a template project for us. There is many options to enable in the creation of a project, a good option is to enable both unit testing &amp; typescript. Once the project has been created, we can navigate into the directory and run <code>npm run serve</code>, this will set up our Vue project to enable us to visit <code>localhost:8080</code>.</p>
<p>Now to set up the user interface for our users to input the index of the fibonacci sequence they wish to calculate, we need to set up a new page for the users to land on. This will involve changing things in 3 places: components, views and router.</p>
<p>This is what we will be building with Vue:</p>
<p><img alt="Vue Fib Input Page" class="img-fluid" src="https://jackmckew.dev/img/vue-fib.png"/></p>
<h3 id="fibinputform-component">FibInputForm Component</h3>
<p>Components are pieces of user interface that we can access in multiple parts of our application, we build a component which will contain both the HTML and javascript for driving the user input, and for displaying the output retrieved from Redis or PostgreSQL. Vue components are typically comprised of a <code>template</code> block and a corresponding <code>script</code> and <code>style</code> block. When writing the template for a component, there is numerous Vue specific attributes that we can provide the elements in the HTML. For this project we will make use of Bulma/Buefy CSS (which can be installed with <code>npm install bulma</code> or <code>npm install buefy</code>) for our styling.</p>
<p>We create a file named <code>FibInputForm.vue</code> inside <code>project_name/src/components</code> with the contents:</p>
<table class="table table-striped highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">template</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"box"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"columns is-centered"</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">form</span> <span class="err">@</span><span class="na">submit</span><span class="err">.</span><span class="na">prevent</span><span class="o">=</span><span class="s">"handleSubmit"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"field has-addons "</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"control"</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">input</span>
              <span class="na">v-model</span><span class="o">=</span><span class="s">"inputValue"</span>
              <span class="na">onfocus</span><span class="o">=</span><span class="s">"if(this.value == 'Enter a value') { this.value = ''; }"</span>
              <span class="na">class</span><span class="o">=</span><span class="s">"input is-primary"</span>
              <span class="na">type</span><span class="o">=</span><span class="s">"text"</span>
            <span class="p">/&gt;</span>
          <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"control"</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">"button is-primary"</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span><span class="p">&gt;</span>Submit<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
          <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">ul</span> <span class="na">v-if</span><span class="o">=</span><span class="s">"seenIndexes &amp;&amp; seenIndexes.length"</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">h3</span><span class="p">&gt;</span>Indexes I have seen:<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>

      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>{{ seenIndexes.map((x) =&gt; x.number).join(", ") }}<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">h3</span><span class="p">&gt;</span>Calculated Values:<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>

      <span class="p">&lt;</span><span class="nt">li</span> <span class="na">v-for</span><span class="o">=</span><span class="s">"(value, name) in values"</span> <span class="na">:key</span><span class="o">=</span><span class="s">"name"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>For index {{ name }}, I calculated {{ value }}<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">template</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="k">import</span> <span class="nx">axios</span> <span class="nx">from</span> <span class="s2">"axios"</span><span class="p">;</span>

<span class="k">export</span> <span class="k">default</span> <span class="p">{</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s2">"FibInput"</span><span class="p">,</span>
  <span class="nx">data</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">seenIndexes</span><span class="o">:</span> <span class="p">[],</span>
      <span class="nx">values</span><span class="o">:</span> <span class="p">{},</span>
      <span class="nx">index</span><span class="o">:</span> <span class="s2">""</span><span class="p">,</span>
      <span class="nx">inputValue</span><span class="o">:</span> <span class="s2">"Enter a value"</span><span class="p">,</span>
    <span class="p">};</span>
  <span class="p">},</span>

  <span class="c1">// // Fetches posts when the component is created.</span>
  <span class="k">async</span> <span class="nx">created</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">values</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"/api/values/current"</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">values</span> <span class="o">=</span> <span class="nx">values</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
      <span class="c1">// this.values = await axios.get("/api/values/current");</span>
      <span class="kd">const</span> <span class="nx">indexes</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"/api/values/all"</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">seenIndexes</span> <span class="o">=</span> <span class="nx">indexes</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">errors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="nx">methods</span><span class="o">:</span> <span class="p">{</span>
    <span class="k">async</span> <span class="nx">handleSubmit</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">await</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">"/api/values"</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">index</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">inputValue</span><span class="p">,</span>
      <span class="p">});</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>

      <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">reload</span><span class="p">();</span>
    <span class="p">},</span>
  <span class="p">},</span>
<span class="p">};</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div>
</td></tr></tbody></table>
<p>To briefly cover the functionality above, the template is built up of 3 parts, the input form where users submit an index to query, a list of the latest indexes as stored in Redis separated by a comma and finally a list of the calculated as retrieved from the PostgreSQL database. We use <code>axios</code> to interface we the API that we will create with <code>express</code>. We query the API upon load, and the page is always reloaded when submit is pressed. Now that this has been exported, it can be imported from any other point in our web application and placed in with a <code>&lt;FibInputForm/&gt;</code> element! Neat!</p>
<h3 id="fibinputpage-view">FibInputPage View</h3>
<p>Now that we have our component, we need a page to put it on! We create a new file within <code>project_name/src/views</code> named <code>FibInputPage.vue</code> with the contents:</p>
<table class="table table-striped highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">template</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">section</span> <span class="na">class</span><span class="o">=</span><span class="s">"section"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"container"</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"columns is-centered"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"column is-half"</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">FibInputForm</span> <span class="p">/&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">template</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="c1">// @ is an alias to /src</span>
<span class="k">import</span> <span class="nx">FibInputForm</span> <span class="nx">from</span> <span class="s2">"@/components/FibInputForm.vue"</span><span class="p">;</span>

<span class="k">export</span> <span class="k">default</span> <span class="p">{</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s2">"Fib"</span><span class="p">,</span>
  <span class="nx">components</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">FibInputForm</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">};</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div>
</td></tr></tbody></table>
<p>As we can see above, we've imported our neat little <code>FibInputForm</code> and used it after placing it in a centered section. Again we export the page view so we can import into the router to make sure it's linked to a URL.</p>
<h3 id="routing-the-page">Routing the Page</h3>
<p>Lastly for Vue, we need to set up a route so users can reach our page, both within the <code>vue-router</code> and on the main page (<code>App.vue</code>). Routes are all defined within <code>project_name/router/index.ts</code>. So we need to add in a new one for our <code>FibInputPage</code> by adding the following object into the routes array:</p>
<table class="table table-striped highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>  {
    path: "/fib",
    name: "Fib",
    // route level code-splitting
    // this generates a separate chunk (about.[hash].js) for this route
    // which is lazy-loaded when the route is visited.
    component: () =&gt;
      import(/* webpackChunkName: "about" */ "../views/FibInputPage.vue"),
  },
</code></pre></div>
</td></tr></tbody></table>
<p>Next to ensure the route is accessible from a link on the page, add a <code>router-link</code> element into the template of <code>App.vue</code>:</p>
<table class="table table-striped highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">router-link</span> <span class="na">to</span><span class="o">=</span><span class="s">"/fib"</span><span class="p">&gt;</span>Fib<span class="p">&lt;/</span><span class="nt">router-link</span><span class="p">&gt;</span> |
</code></pre></div>
</td></tr></tbody></table>
<h2 id="redis">Redis</h2>
<p><em>Find all the source code for the redis service at: <a href="https://github.com/JackMcKew/multi-docker/tree/master/worker">https://github.com/JackMcKew/multi-docker/tree/master/worker</a></em></p>
<p>Redis is an open source, in-memory data store, we give it a key and a value, which it'll store. Later we can ask with the key, and get the value back. We are going to set up two parts to make this service work as expected. The redis runtime is managed for us directly from using the redis image as provided on Docker Hub, but we need to make a node.js project to interface with it.</p>
<p>We do this by creating 3 files: <code>package.json</code>, <code>index.js</code> and <code>keys.js</code>. <code>package.json</code> defines what dependencies need to be installed, and how to run the project. <code>index.js</code> manages the redis client and contains the functionality for calculating the fibonacci sequence when given an index. <code>keys.js</code> contains any environment variables that the project may need. In particular we use environment variables so docker-compose can link all the services together later on.</p>
<p>Here is the code for the core of this project, <code>index.js</code>:</p>
<table class="table table-striped highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">const</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"./keys"</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">redis</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"redis"</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">redisClient</span> <span class="o">=</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">createClient</span><span class="p">({</span>
  <span class="nx">host</span><span class="o">:</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">redisHost</span><span class="p">,</span>
  <span class="nx">port</span><span class="o">:</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">redisPort</span><span class="p">,</span>
  <span class="nx">retry_strategy</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="mf">1000</span><span class="p">,</span>
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">sub</span> <span class="o">=</span> <span class="nx">redisClient</span><span class="p">.</span><span class="nx">duplicate</span><span class="p">();</span>

<span class="kd">function</span> <span class="nx">fib</span><span class="p">(</span><span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">&lt;</span> <span class="mf">2</span><span class="p">)</span> <span class="k">return</span> <span class="mf">1</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">fib</span><span class="p">(</span><span class="nx">index</span> <span class="o">-</span> <span class="mf">1</span><span class="p">)</span> <span class="o">+</span> <span class="nx">fib</span><span class="p">(</span><span class="nx">index</span> <span class="o">-</span> <span class="mf">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">sub</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"message"</span><span class="p">,</span> <span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">redisClient</span><span class="p">.</span><span class="nx">hset</span><span class="p">(</span><span class="s2">"values"</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">fib</span><span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">message</span><span class="p">)));</span>
<span class="p">});</span>

<span class="nx">sub</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s2">"insert"</span><span class="p">);</span>
</code></pre></div>
</td></tr></tbody></table>
<p>As we can see, we initialise a redis client as per the environment variables set in <code>keys.js</code>, we create a duplicate of the client because we wish to interact with it (must duplicate the client otherwise when communicating we'll end up with one big mess). We define our ever so special fibonacci function (this is slow on purpose) and finally we set a method that when given a message will communicate with redis for us.</p>
<h2 id="postgresql">PostgreSQL</h2>
<p><em>Find all the source code for the PostgreSQL service at: <a href="https://github.com/JackMcKew/multi-docker/tree/master/server">https://github.com/JackMcKew/multi-docker/tree/master/server</a></em></p>
<p>We are going to use the PostgreSQL service part of our project to contain the interface with the database, and the API with <code>express</code>. Very similar to our redis project, we need a <code>package.json</code>, <code>index.js</code> and <code>keys.js</code>. Let's dive straight into the code inside <code>index.js</code>:</p>
<table class="table table-striped highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">const</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"./keys"</span><span class="p">);</span>

<span class="c1">// Express App Setup</span>
<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"express"</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">bodyParser</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"body-parser"</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"cors"</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cors</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>

<span class="c1">// Create and Connect to Postgres Client</span>

<span class="kd">const</span> <span class="p">{</span>
    <span class="nx">Pool</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"pg"</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">pgClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Pool</span><span class="p">({</span>
    <span class="nx">user</span><span class="o">:</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">pgUser</span><span class="p">,</span>
    <span class="nx">host</span><span class="o">:</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">pgHost</span><span class="p">,</span>
    <span class="nx">database</span><span class="o">:</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">pgDatabase</span><span class="p">,</span>
    <span class="nx">password</span><span class="o">:</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">pgPassword</span><span class="p">,</span>
    <span class="nx">port</span><span class="o">:</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">pgPort</span><span class="p">,</span>
<span class="p">});</span>
<span class="nx">pgClient</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'connect'</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">pgClient</span>
        <span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">'CREATE TABLE IF NOT EXISTS values (number INT)'</span><span class="p">)</span>
        <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">))</span>
<span class="p">})</span>


<span class="c1">// Create and Connect to Redis Client</span>
<span class="kd">const</span> <span class="nx">redis</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"redis"</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">redisClient</span> <span class="o">=</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">createClient</span><span class="p">({</span>
    <span class="nx">host</span><span class="o">:</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">redisHost</span><span class="p">,</span>
    <span class="nx">port</span><span class="o">:</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">redisPort</span><span class="p">,</span>
    <span class="nx">retry_strategy</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="mf">1000</span><span class="p">,</span>
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">redisPublisher</span> <span class="o">=</span> <span class="nx">redisClient</span><span class="p">.</span><span class="nx">duplicate</span><span class="p">();</span>

<span class="c1">// Express Route Handlers</span>

<span class="c1">// Test Route</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"/"</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">"Hello there"</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// All indices submitted to DB</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"/values/all"</span><span class="p">,</span> <span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">values</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">pgClient</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s2">"SELECT * FROM values"</span><span class="p">);</span>

    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">rows</span><span class="p">);</span>
    <span class="c1">// res.send(values.map(x =&gt; x.number))</span>
<span class="p">});</span>

<span class="c1">// Get current indices in Redis</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"/values/current"</span><span class="p">,</span> <span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">redisClient</span><span class="p">.</span><span class="nx">hgetall</span><span class="p">(</span><span class="s2">"values"</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">values</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">values</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">});</span>

<span class="c1">// Receive new values</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">"/values"</span><span class="p">,</span> <span class="k">async</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>

    <span class="kd">const</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">index</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">index</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">40</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">422</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="s2">"Index too high, try smaller number"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">redisClient</span><span class="p">.</span><span class="nx">hset</span><span class="p">(</span><span class="s2">"values"</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="s2">"Nothing yet!"</span><span class="p">);</span>

    <span class="nx">redisPublisher</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s2">"insert"</span><span class="p">,</span> <span class="nx">index</span><span class="p">);</span>

    <span class="nx">pgClient</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s2">"INSERT INTO values(number) VALUES($1)"</span><span class="p">,</span> <span class="p">[</span><span class="nx">index</span><span class="p">]);</span>

    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
        <span class="nx">working</span><span class="o">:</span> <span class="kc">true</span>
    <span class="p">});</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mf">5000</span><span class="p">,</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Listening"</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
</td></tr></tbody></table>
<p>We do a series of things here:</p>
<ol>
<li>Initialise our <code>express</code> router which will be the API</li>
<li>Create a client for the PostgreSQL database (ensuring to create a table if it doesn't exist)</li>
<li>Create another client for our redis service, which will publish any keys requested as to show to the user later on</li>
<li>Set up our API end points, to either get all the indexes ever requested or the latest</li>
<li>Set up the API post method, which will handle sending the request to redis and storing in the database</li>
<li>Listen on the port for any incoming requests!</li>
</ol>
<h2 id="nginx">Nginx</h2>
<p>Nginx in this project helps us create all the connections between the services and for them all to play nicely. How nginx works is by defining any connections in a configuration file, and pass that configuration file upon runtime.</p>
<p>This is our <code>default.conf</code> nginx configuration for this project:</p>
<table class="table table-striped highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">upstream</span> <span class="s">client</span> <span class="p">{</span>
    <span class="kn">server</span> <span class="n">client</span><span class="p">:</span><span class="mi">8080</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">upstream</span> <span class="s">api</span> <span class="p">{</span>
    <span class="kn">server</span> <span class="n">api</span><span class="p">:</span><span class="mi">5000</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>

    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
        <span class="kn">proxy_pass</span> <span class="s">http://client</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kn">location</span> <span class="s">/api</span> <span class="p">{</span>
        <span class="kn">rewrite</span> <span class="s">/api/(.*)</span> <span class="s">/</span><span class="nv">$1</span> <span class="s">break</span><span class="p">;</span>
        <span class="kn">proxy_pass</span> <span class="s">http://api</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></tbody></table>
<p>We are doing a series of things once again:</p>
<ol>
<li>Our Vue front end listens on port 8080 by default, so that's where the client connection lives</li>
<li>Our API back-end (PostgreSQL) is listening on port 5000</li>
<li>Our nginx runtime will listen on port 80 and route as required</li>
</ol>
<p>We also set up a few locations, these help nginx 'finish' the route. <code>/</code> means any incoming connection, pass it off to the front end to render. If any request connection comes in containing <code>/api</code> then we want to pass that request to the service, so we rewrite the URL to be the correct URL.</p>
<h2 id="docker-compose">Docker Compose</h2>
<p>Now that we've got our individual services all configured, we need a way to run them all at the same time. We need to create a <code>docker-compose.yml</code> which will contain all the environment variables, and how each service depend/connect to each other so we can run it all!</p>
<table class="table table-striped highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nt">version</span><span class="p">:</span> <span class="s">"3"</span>
<span class="nt">services</span><span class="p">:</span>
  <span class="nt">postgres</span><span class="p">:</span>
    <span class="nt">image</span><span class="p">:</span> <span class="s">"postgres:latest"</span>
    <span class="nt">environment</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">POSTGRES_PASSWORD=postgres_password</span>
  <span class="nt">redis</span><span class="p">:</span>
    <span class="nt">image</span><span class="p">:</span> <span class="s">"redis:latest"</span>
  <span class="nt">api</span><span class="p">:</span>
    <span class="nt">depends_on</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">postgres</span>
    <span class="nt">build</span><span class="p">:</span>
      <span class="nt">dockerfile</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Dockerfile.dev</span>
      <span class="nt">context</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./server</span>
    <span class="nt">volumes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/app/node_modules</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">./server:/app</span>
    <span class="nt">environment</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">REDIS_HOST=redis</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">REDIS_PORT=6379</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">PGUSER=postgres</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">PGHOST=postgres</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">PGDATABASE=postgres</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">PGPASSWORD=postgres_password</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">PGPORT=5432</span>
  <span class="nt">client</span><span class="p">:</span>
    <span class="nt">build</span><span class="p">:</span>
      <span class="nt">dockerfile</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Dockerfile.dev</span>
      <span class="nt">context</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./client</span>
    <span class="nt">volumes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/app/node_modules</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">./client:/app</span>
  <span class="nt">worker</span><span class="p">:</span>
    <span class="nt">build</span><span class="p">:</span>
      <span class="nt">dockerfile</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Dockerfile.dev</span>
      <span class="nt">context</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./worker</span>
    <span class="nt">volumes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/app/node_modules</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">./worker:/app</span>
    <span class="nt">environment</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">REDIS_HOST=redis</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">REDIS_PORT=6379</span>
  <span class="nt">nginx</span><span class="p">:</span>
    <span class="nt">depends_on</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">api</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">client</span>
    <span class="nt">restart</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">always</span>
    <span class="nt">build</span><span class="p">:</span>
      <span class="nt">dockerfile</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Dockerfile.dev</span>
      <span class="nt">context</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./nginx</span>
    <span class="nt">ports</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">"8000:80"</span>
</code></pre></div>
</td></tr></tbody></table>
<p>Here we are setting up all of the docker containers we wish to run in parallel that will make up our entire project:</p>
<ul>
<li>PostgreSQL Container<ul>
<li>We use the postgres image on Docker Hub and must pass in the default password to get into it</li>
</ul>
</li>
<li>Redis Container<ul>
<li>We use the redis image on Docker Hub (that easy!)</li>
</ul>
</li>
<li>API Container<ul>
<li>This contains the code behind the API which interfaces with redis &amp; postgres</li>
</ul>
</li>
<li>Client Container<ul>
<li>Our Vue frontend that the users will see</li>
</ul>
</li>
<li>Worker Container<ul>
<li>This contains the code to calculate the fibonacci sequence by interfacing with the redis runtime</li>
</ul>
</li>
<li>Nginx Container<ul>
<li>Our nginx container that'll handle all the routing in between each of the services, this is what is exposed on port 8000 on the local PC when we run all these containers</li>
</ul>
</li>
</ul>
<p>Note that our environment variables (which were set in <code>keys.js</code> earlier), are just the name of the service given in the <code>docker-compose.yml</code> file. Docker Compose handles all the renaming when each service is connected up for us! How awesome is that!</p>
<h2 id="github-actions">Github Actions</h2>
<p>Now that we've set all of services and make sure they place nice in Docker Compose, it's time to implement CI/CD with Github Actions so whenever we push new versions of our code, it'll automatically test that everything works and deploy our new version of the application. We do this by creating a <code>test-and-deploy.yml</code> within <code>.github/workflows/</code> which contains:</p>
<table class="table table-striped highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Test &amp; Deploy</span>
<span class="nt">on</span><span class="p">:</span>
  <span class="nt">push</span><span class="p">:</span>
    <span class="nt">branches</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">master</span>

<span class="nt">jobs</span><span class="p">:</span>
  <span class="nt">test-and-deploy</span><span class="p">:</span>
    <span class="nt">runs-on</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
    <span class="nt">steps</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Checkout Latest Repo</span>
        <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">actions/checkout@master</span>

      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Build Dev Docker Image - Client</span>
        <span class="nt">run</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">docker build -t jackmckew/multi-docker-dev -f ./client/Dockerfile.dev ./client</span>

      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Run Test Suite - Client</span>
        <span class="nt">run</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">docker run -e CI=true jackmckew/multi-docker-dev npm run test:unit</span>

      <span class="c1"># Deploy to Dockerhub</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Build and Push Production Container - Client</span>
        <span class="nt">if</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">success()</span>
        <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">docker/build-push-action@v1</span>
        <span class="nt">with</span><span class="p">:</span>
          <span class="nt">username</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ secrets.DOCKER_USERNAME }}</span>
          <span class="nt">password</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ secrets.DOCKER_PASSWORD }}</span>
          <span class="nt">repository</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jackmckew/multi-docker-client</span>
          <span class="nt">tags</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">latest</span>
          <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./client</span>

      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Build and Push Production Container - Server</span>
        <span class="nt">if</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">success()</span>
        <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">docker/build-push-action@v1</span>
        <span class="nt">with</span><span class="p">:</span>
          <span class="nt">username</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ secrets.DOCKER_USERNAME }}</span>
          <span class="nt">password</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ secrets.DOCKER_PASSWORD }}</span>
          <span class="nt">repository</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jackmckew/multi-docker-server</span>
          <span class="nt">tags</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">latest</span>
          <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./server</span>

      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Build and Push Production Container - Nginx</span>
        <span class="nt">if</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">success()</span>
        <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">docker/build-push-action@v1</span>
        <span class="nt">with</span><span class="p">:</span>
          <span class="nt">username</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ secrets.DOCKER_USERNAME }}</span>
          <span class="nt">password</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ secrets.DOCKER_PASSWORD }}</span>
          <span class="nt">repository</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jackmckew/multi-docker-nginx</span>
          <span class="nt">tags</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">latest</span>
          <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./nginx</span>

      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Build and Push Production Container - Worker</span>
        <span class="nt">if</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">success()</span>
        <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">docker/build-push-action@v1</span>
        <span class="nt">with</span><span class="p">:</span>
          <span class="nt">username</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ secrets.DOCKER_USERNAME }}</span>
          <span class="nt">password</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ secrets.DOCKER_PASSWORD }}</span>
          <span class="nt">repository</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jackmckew/multi-docker-worker</span>
          <span class="nt">tags</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">latest</span>
          <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./worker</span>

      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Generate deployment package</span>
        <span class="nt">run</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">zip -r deploy.zip . -x '*.git*'</span>

      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Deploy to EB</span>
        <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">einaregilsson/beanstalk-deploy@v11</span>
        <span class="nt">with</span><span class="p">:</span>
          <span class="nt">aws_access_key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ secrets.AWS_ACCESS_KEY_ID }}</span>
          <span class="nt">aws_secret_key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ secrets.AWS_SECRET_ACCESS_KEY }}</span>
          <span class="nt">application_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mulit-docker</span>
          <span class="nt">environment_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">MulitDocker-env</span>
          <span class="nt">version_label</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">12345</span>
          <span class="nt">version_description</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{github.SHA}}</span>
          <span class="nt">region</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ap-southeast-2</span>
          <span class="nt">deployment_package</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">deploy.zip</span>
</code></pre></div>
</td></tr></tbody></table>
<p>We are doing the following steps:</p>
<ol>
<li>Get the latest copy of all the source code</li>
<li>Build &amp; Test our application to make sure it works</li>
<li>Build &amp; Publish each container to Docker Hub so any other deployment service can pull directly from there</li>
<li>Deploy our application to Elastic Beanstalk</li>
</ol>
<h2 id="docker-hub">Docker Hub</h2>
<p>Everything's now set up! For another user or a deployment service to get each of the images for the services they've created they can now simply run <code>docker run jackmckew/multi-docker-client</code> and that's it! It should run on any operating system provided Docker is installed, how cool is that!</p>
<h2 id="deploying-to-aws-elastic-beanstalk">Deploying to AWS Elastic Beanstalk</h2>
<p>Now we want to deploy this application to Elastic Beanstalk, that means we need to create a <code>Dockerrun.aws.json</code> which is very similar to that of the <code>docker-compose.yml</code>. The contents of the json file will be:</p>
<table class="table table-striped highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">{</span>
    <span class="nt">"AWSEBDockerrunVersion"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="nt">"containerDefinitions"</span><span class="p">:</span> <span class="p">[{</span>
            <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"client"</span><span class="p">,</span>
            <span class="nt">"image"</span><span class="p">:</span> <span class="s2">"jackmckew/multi-docker-client"</span><span class="p">,</span>
            <span class="nt">"hostname"</span><span class="p">:</span> <span class="s2">"client"</span><span class="p">,</span>
            <span class="nt">"essential"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
            <span class="nt">"memory"</span><span class="p">:</span> <span class="mi">128</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"server"</span><span class="p">,</span>
            <span class="nt">"image"</span><span class="p">:</span> <span class="s2">"jackmckew/multi-docker-server"</span><span class="p">,</span>
            <span class="nt">"hostname"</span><span class="p">:</span> <span class="s2">"api"</span><span class="p">,</span>
            <span class="nt">"essential"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
            <span class="nt">"memory"</span><span class="p">:</span> <span class="mi">128</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"worker"</span><span class="p">,</span>
            <span class="nt">"image"</span><span class="p">:</span> <span class="s2">"jackmckew/multi-docker-worker"</span><span class="p">,</span>
            <span class="nt">"hostname"</span><span class="p">:</span> <span class="s2">"worker"</span><span class="p">,</span>
            <span class="nt">"essential"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
            <span class="nt">"memory"</span><span class="p">:</span> <span class="mi">128</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"nginx"</span><span class="p">,</span>
            <span class="nt">"image"</span><span class="p">:</span> <span class="s2">"jackmckew/multi-docker-nginx"</span><span class="p">,</span>
            <span class="nt">"essential"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nt">"portMappings"</span><span class="p">:</span> <span class="p">[{</span>
                <span class="nt">"hostPort"</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
                <span class="nt">"containerPort"</span><span class="p">:</span> <span class="mi">80</span>
            <span class="p">}],</span>
            <span class="nt">"links"</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">"client"</span><span class="p">,</span> <span class="s2">"server"</span>
            <span class="p">],</span>
            <span class="nt">"memory"</span><span class="p">:</span> <span class="mi">128</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></tbody></table>
<p>Now provided we've set up the following:</p>
<ul>
<li>RDS - Redis</li>
<li>ElasticCache - PostgreSQL</li>
<li>VPC - Security Group</li>
<li>Initialized all the environment variables in the EB instance</li>
</ul>
<p>We should be able to push to Github and see our application be deployed!</p></body>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://jackmckew.dev/tag/software.html">software</a>
    </p>
  </div>


  <div class="neighbors">
    <a class="btn float-left" href="https://jackmckew.dev/develop-and-deploy-with-docker.html" title="Develop and Deploy with Docker">
      <i class="fa fa-angle-left"></i>  Previous Post
    </a>
    <a class="btn float-right" href="https://jackmckew.dev/intro-to-kubernetes.html" title="Intro to Kubernetes">
       Next Post <i class="fa fa-angle-right"></i>
    </a>
  </div>

  <div class="related-posts">
    <h4> You might enjoy</h4>
    <ul class="related-posts">
      <li><a href="https://jackmckew.dev/episode-12-what-is-git.html">Episode 12 - What is Git?</a></li>
    </ul>
  </div>


<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'jackmckew-dev';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
     Please enable JavaScript to view comments.
</noscript>
<!-- End Disqus -->
</article>

        <footer>
<p>&copy;  </p>
<p> Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme</p>        </footer>
    </main>

<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Jack McKew's Blog ",
  "url" : "https://jackmckew.dev",
  "image": "/jm-photo.jpg",
  "description": ""
}
</script>    <script>
        $(document).ready(function() {
            $('#tipue_search_input').tipuesearch();
        });
    </script>
</body>

</html>